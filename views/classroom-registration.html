<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Events Registration - Perseverantia 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @font-face {
            font-family: Mestizo;
            src: url('/assets/MestizoFont.ttf');
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0D122C 0%, #131D3F 100%);
        }
        
        .form-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(190, 142, 48, 0.3);
            transition: all 0.3s ease;
        }
        
        .form-card:hover {
            border-color: #BE8E30;
            box-shadow: 0 0 30px rgba(190, 142, 48, 0.2);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(190, 142, 48, 0.3);
            color: white;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #BE8E30;
            box-shadow: 0 0 20px rgba(190, 142, 48, 0.3);
            outline: none;
        }
        
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Custom Select Styling for Safari/WebKit */
        select.input-field {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23BE8E30' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        select.input-field option {
            background: #0D122C;
            color: white;
            border: none;
        }
        
        /* Ensure consistent height on Safari */
        select.input-field {
            min-height: 44px; /* Minimum touch target for mobile Safari */
        }
        
        .event-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(190, 142, 48, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .event-toggle.active {
            background: rgba(190, 142, 48, 0.2);
            border-color: #BE8E30;
            box-shadow: 0 0 20px rgba(190, 142, 48, 0.3);
        }
        
        .participant-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(190, 142, 48, 0.2);
            transition: all 0.3s ease;
            transform: translateY(20px);
            opacity: 0;
            animation: slideIn 0.5s ease forwards;
        }
        
        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #BE8E30, #FFD700);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #FFD700, #BE8E30);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(190, 142, 48, 0.4);
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid #BE8E30;
            color: #BE8E30;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #BE8E30;
            color: #0D122C;
        }
        
        .loading-spinner {
            border: 3px solid rgba(190, 142, 48, 0.3);
            border-top: 3px solid #BE8E30;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: linear-gradient(135deg, #10B981, #059669);
            border: 1px solid #065F46;
        }
        
        .error-message {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            border: 1px solid #991B1B;
        }

        .participant-counter {
            background: rgba(190, 142, 48, 0.1);
            border: 1px solid rgba(190, 142, 48, 0.3);
            color: #BE8E30;
        }
        
        /* Custom Radio Button Styles */
        .custom-radio {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .custom-radio input[type="radio"] {
            opacity: 0;
            position: absolute;
            width: 0;
            height: 0;
        }
        
        .radio-indicator {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(190, 142, 48, 0.5);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            margin-right: 8px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .radio-indicator::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #BE8E30;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease;
        }
        
        .custom-radio input[type="radio"]:checked + .radio-indicator {
            border-color: #BE8E30;
            background: rgba(190, 142, 48, 0.1);
            box-shadow: 0 0 10px rgba(190, 142, 48, 0.3);
        }
        
        .custom-radio input[type="radio"]:checked + .radio-indicator::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .custom-radio:hover .radio-indicator {
            border-color: #BE8E30;
            background: rgba(190, 142, 48, 0.05);
        }
        
        .radio-label {
            color: white;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .custom-radio:hover .radio-label {
            color: #BE8E30;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="border-b border-[#BE8E30]/30 mb-8">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="/assets/persevlogo.png" alt="Perseverantia Logo" class="w-12 h-12">
                    <div>
                        <h1 class="text-3xl text-white" style="font-family: Mestizo">Classroom Events Registration</h1>
                        <p class="text-gray-300 text-sm">Perseverantia 2025</p>
                    </div>
                </div>
                <a href="/panel" class="text-[#BE8E30] hover:text-white transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 pb-12">
        <div class="max-w-4xl mx-auto">
            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="flex items-center justify-between text-sm text-gray-300 mb-2">
                    <span>Registration Progress</span>
                    <span id="progress-text">Step 1 of 2</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progress-bar" class="bg-gradient-to-r from-[#BE8E30] to-[#FFD700] h-2 rounded-full transition-all duration-500" style="width: 50%"></div>
                </div>
            </div>

            <!-- Registration Form -->
            <form id="registrationForm" class="space-y-8">
                <!-- School Information Section -->
                <div class="form-card rounded-3xl p-8" id="school-section">
                    <h2 class="text-2xl text-white mb-6 flex items-center" style="font-family: Mestizo">
                        <i class="fas fa-school text-[#BE8E30] mr-3"></i>
                        School Information
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-white mb-2 font-medium">Institution Name</label>
                            <input type="text" name="schoolName" readonly 
                                   class="input-field w-full px-4 py-3 rounded-xl opacity-75 cursor-not-allowed"
                                   placeholder="Loading school information...">
                            <p class="text-gray-400 text-xs mt-1">Auto-populated from your account</p>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2 font-medium">Contingent Code</label>
                            <input type="text" name="contingentCode" readonly 
                                   class="input-field w-full px-4 py-3 rounded-xl opacity-75 cursor-not-allowed"
                                   placeholder="Loading...">
                            <p class="text-gray-400 text-xs mt-1">Auto-populated from your account</p>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2 font-medium">Teacher In-charge Name *</label>
                            <input type="text" name="teacherName" required 
                                   class="input-field w-full px-4 py-3 rounded-xl"
                                   placeholder="Enter teacher's full name">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2 font-medium">Teacher Mobile Number *</label>
                            <input type="tel" name="teacherMobile" required 
                                   class="input-field w-full px-4 py-3 rounded-xl"
                                   placeholder="Enter mobile number">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-white mb-2 font-medium">Teacher Email Address *</label>
                            <input type="email" name="teacherEmail" required 
                                   class="input-field w-full px-4 py-3 rounded-xl"
                                   placeholder="Enter email address">
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-8">
                        <button type="button" id="continue-to-events" 
                                class="btn-primary px-8 py-3 rounded-xl text-white font-medium">
                            Continue to Events <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Events Section -->
                <div class="form-card rounded-3xl p-8 hidden" id="events-section">
                    <h2 class="text-2xl text-white mb-6 flex items-center" style="font-family: Mestizo">
                        <i class="fas fa-chalkboard-teacher text-[#BE8E30] mr-3"></i>
                        Classroom Events Selection
                    </h2>
                    
                    <p class="text-gray-300 mb-8">
                        Select the classroom events you want to participate in and add your team members. 
                        You can participate in multiple events with different teams.
                    </p>
                    
                    <div class="bg-blue-900/30 border border-blue-500/30 rounded-xl p-4 mb-8" id="registration-notice">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-400 mr-3" id="notice-icon"></i>
                            <div id="notice-content">
                                <p class="text-blue-300 font-medium" id="notice-title">Registration Notice</p>
                                <p class="text-blue-200 text-sm" id="notice-text">Please select your preferred events below. You can modify your registration details at any time until <strong>September 12, 2025</strong>.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Events Container -->
                    <div id="events-container" class="space-y-6">
                        <!-- Events will be loaded dynamically -->
                    </div>

                    <!-- Existing Registrations Summary (Edit Mode Only) -->
                    <div id="existing-summary" class="hidden bg-green-900/30 border border-green-500/30 rounded-xl p-6 mt-8">
                        <h3 class="text-lg text-green-300 font-medium mb-4 flex items-center">
                            <i class="fas fa-check-circle mr-3"></i>
                            Current Registrations
                        </h3>
                        <div id="summary-content" class="space-y-3">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex flex-col sm:flex-row justify-between gap-4 mt-8">
                        <button type="button" id="back-to-school" 
                                class="btn-secondary px-8 py-3 rounded-xl font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>Back
                        </button>
                        <button type="submit" id="submit-registration" 
                                class="btn-primary px-8 py-3 rounded-xl text-white font-medium">
                            <span id="submit-text">Submit Registration</span>
                            <div id="submit-spinner" class="loading-spinner hidden inline-block ml-2"></div>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Success/Error Messages -->
            <div id="message-container" class="hidden mt-8">
                <!-- Messages will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let classroomEvents = [
            {
                _id: 'admeta-cat1',
                name: 'Admeta: Category 1',
                description: 'Academic debate - Grades 9-10',
                minParticipants: 2,
                maxParticipants: 2,
                minGrade: 9,
                maxGrade: 10,
                genderRequirement: 'any'
            },
            {
                _id: 'admeta-cat2',
                name: 'Admeta: Category 2',
                description: 'Academic debate - Grades 11-12',
                minParticipants: 2,
                maxParticipants: 2,
                minGrade: 11,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'artem',
                name: 'Artem',
                description: 'Art and creativity challenge - Grades 11-12',
                minParticipants: 1,
                maxParticipants: 1,
                minGrade: 11,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'carmen-cat1',
                name: 'Carmen: Category 1',
                description: 'Poetry and creative writing - Grades 9-10',
                minParticipants: 1,
                maxParticipants: 1,
                minGrade: 9,
                maxGrade: 10,
                genderRequirement: 'any'
            },
            {
                _id: 'carmen-cat2',
                name: 'Carmen: Category 2',
                description: 'Poetry and creative writing - Grades 11-12',
                minParticipants: 1,
                maxParticipants: 1,
                minGrade: 11,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'fabula',
                name: 'Fabula',
                description: 'Storytelling and narrative - Grades 9-12',
                minParticipants: 4,
                maxParticipants: 10,
                minGrade: 9,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'fortuna',
                name: 'Fortuna',
                description: 'Strategy and luck-based games - Grades 9-12',
                minParticipants: 2,
                maxParticipants: 3,
                minGrade: 9,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'codeferno',
                name: 'Codeferno',
                description: 'Programming and coding competition - Grades 9-12',
                minParticipants: 1,
                maxParticipants: 1,
                minGrade: 9,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'gustatio',
                name: 'Gustatio',
                description: 'Culinary arts and cooking challenge - Grades 9-12',
                minParticipants: 2,
                maxParticipants: 2,
                minGrade: 9,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'mahim16',
                name: 'Mahim 16',
                description: 'Local knowledge and trivia - Grades 9-12',
                minParticipants: 3,
                maxParticipants: 4,
                minGrade: 9,
                maxGrade: 12,
                genderRequirement: 'any'
            },
            {
                _id: 'adventurium',
                name: "‘Ad’venturium",
                description: 'Business and entrepreneurship - Grades 9-12',
                minParticipants: 2,
                maxParticipants: 2,
                minGrade: 9,
                maxGrade: 12,
                genderRequirement: 'grade_mixed_required'
            }
        ];
        
        let currentStep = 1;
        let editMode = false;
        let existingRegistrations = [];

        // Initialize form
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            editMode = urlParams.get('mode') === 'edit';
            
            await loadUserSchoolInfo();
            
            if (editMode) {
                await loadExistingRegistrations();
                updateHeaderForEditMode();
            }
            
            renderEvents();
            setupEventListeners();
            
            if (editMode && existingRegistrations.length > 0) {
                populateExistingData();
            }
        });

        // Update header for edit mode
        function updateHeaderForEditMode() {
            const title = document.querySelector('h1');
            const subtitle = document.querySelector('.text-gray-300');
            title.textContent = 'Modify Classroom Events Registration';
            subtitle.textContent = 'Update your existing registration details';
        }

        // Load existing registrations
        async function loadExistingRegistrations() {
            try {
                const response = await fetch('/api/check-classroom-registration');
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasRegistration) {
                        existingRegistrations = data.registrations;
                        
                        // Pre-populate school info from existing registration
                        if (data.school) {
                            document.querySelector('[name="teacherName"]').value = data.school.teacherName || '';
                            document.querySelector('[name="teacherMobile"]').value = data.school.teacherMobile || '';
                            document.querySelector('[name="teacherEmail"]').value = data.school.teacherEmail || '';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading existing registrations:', error);
            }
        }

        // Populate existing registration data
        function populateExistingData() {
            existingRegistrations.forEach(registration => {
                const eventId = registration.eventId;
                
                // Select "Yes" for this event
                const yesRadio = document.querySelector(`input[name="participate_${eventId}"][value="yes"]`);
                if (yesRadio) {
                    yesRadio.checked = true;
                    toggleEvent(eventId, true);
                    
                    // Add participants
                    setTimeout(() => {
                        const participantList = document.getElementById(`participant_list_${eventId}`);
                        participantList.innerHTML = ''; // Clear auto-added participants
                        
                        registration.participants.forEach((participant, index) => {
                            addParticipant(eventId);
                            
                            // Fill participant data
                            setTimeout(() => {
                                const cards = participantList.querySelectorAll('.participant-card');
                                const currentCard = cards[index];
                                if (currentCard) {
                                    const nameInput = currentCard.querySelector(`input[name="participant_name_${eventId}[]"]`);
                                    const gradeSelect = currentCard.querySelector(`select[name="participant_grade_${eventId}[]"]`);
                                    
                                    if (nameInput) nameInput.value = participant.name;
                                    if (gradeSelect) gradeSelect.value = participant.grade;
                                }
                            }, 100);
                        });
                        
                        updateParticipantCount(eventId);
                        validateEvent(eventId);
                    }, 200);
                }
            });
        }

        // Load user's school information
        async function loadUserSchoolInfo() {
            try {
                const response = await fetch('/api/user/school-info');
                if (response.ok) {
                    const schoolInfo = await response.json();
                    document.querySelector('[name="schoolName"]').value = schoolInfo.name;
                    document.querySelector('[name="contingentCode"]').value = schoolInfo.contingentCode;
                } else {
                    console.error('Could not load school information');
                    showMessage('Could not load school information. Please refresh the page.', 'error');
                }
            } catch (error) {
                console.error('Error loading school info:', error);
                showMessage('Error loading school information. Please refresh the page.', 'error');
            }
        }

        // Render events dynamically
        function renderEvents() {
            const container = document.getElementById('events-container');
            container.innerHTML = '';

            classroomEvents.forEach(event => {
                const eventCard = createEventCard(event);
                container.appendChild(eventCard);
            });
        }

        // Create event card HTML
        function createEventCard(event) {
            const div = document.createElement('div');
            div.className = 'event-toggle rounded-2xl p-6';
            div.dataset.eventId = event._id;
            
            const specialRequirement = event.genderRequirement === 'grade_mixed_required' ? 
                '<span class="text-[#BE8E30]">One Grade 9-10 + One Grade 11-12 required</span>' : '';
            
            div.innerHTML = `
                <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-4 gap-4">
                    <div class="flex-1">
                        <h3 class="text-xl text-white font-bold">${event.name}</h3>
                        <p class="text-gray-300 text-sm">${event.description}</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-sm">
                            <span class="text-[#BE8E30]">Grades: ${event.minGrade}-${event.maxGrade}</span>
                            <span class="text-[#BE8E30]">Team: ${event.minParticipants === event.maxParticipants ? event.minParticipants : event.minParticipants + '-' + event.maxParticipants} participants</span>
                            ${specialRequirement}
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 flex-shrink-0">
                        <label class="text-white font-medium text-center sm:text-left">Participate:</label>
                        <div class="flex justify-center sm:justify-start space-x-3">
                            <label class="custom-radio">
                                <input type="radio" name="participate_${event._id}" value="yes" 
                                       onchange="toggleEvent('${event._id}', true)">
                                <div class="radio-indicator"></div>
                                <span class="radio-label">Yes</span>
                            </label>
                            <label class="custom-radio">
                                <input type="radio" name="participate_${event._id}" value="no" 
                                       onchange="toggleEvent('${event._id}', false)" checked>
                                <div class="radio-indicator"></div>
                                <span class="radio-label">No</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div id="participants_${event._id}" class="hidden">
                    <div class="border-t border-[#BE8E30]/30 pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg text-white font-medium">Team Members</h4>
                            <div class="participant-counter px-3 py-1 rounded-full text-sm font-medium">
                                <span id="count_${event._id}">0</span> / ${event.maxParticipants} participants
                            </div>
                        </div>
                        
                        <div id="participant_list_${event._id}" class="space-y-4 mb-4">
                            <!-- Participants will be added here -->
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="button" onclick="addParticipant('${event._id}')" 
                                    id="add_btn_${event._id}"
                                    class="btn-secondary px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-plus mr-2"></i>Add Participant
                            </button>
                            <button type="button" onclick="removeLastParticipant('${event._id}')" 
                                    id="remove_btn_${event._id}" class="btn-secondary px-4 py-2 rounded-lg text-sm hidden">
                                <i class="fas fa-minus mr-2"></i>Remove Last
                            </button>
                        </div>
                        
                        <div id="validation_${event._id}" class="mt-4 text-sm"></div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Toggle event participation
        function toggleEvent(eventId, participate) {
            const participantsSection = document.getElementById(`participants_${eventId}`);
            const eventCard = document.querySelector(`[data-event-id="${eventId}"]`);
            
            if (participate) {
                participantsSection.classList.remove('hidden');
                eventCard.classList.add('active');
                
                // Add minimum required participants
                const event = classroomEvents.find(e => e._id === eventId);
                const currentCount = document.querySelectorAll(`#participant_list_${eventId} .participant-card`).length;
                
                for (let i = currentCount; i < event.minParticipants; i++) {
                    addParticipant(eventId);
                }
            } else {
                participantsSection.classList.add('hidden');
                eventCard.classList.remove('active');
                
                // Clear all participants
                document.getElementById(`participant_list_${eventId}`).innerHTML = '';
                updateParticipantCount(eventId);
            }
        }

        // Add participant
        function addParticipant(eventId) {
            const event = classroomEvents.find(e => e._id === eventId);
            const participantList = document.getElementById(`participant_list_${eventId}`);
            const currentCount = participantList.children.length;
            
            if (currentCount >= event.maxParticipants) {
                showMessage(`Maximum ${event.maxParticipants} participants allowed for ${event.name}`, 'error');
                return;
            }
            
            const participantIndex = currentCount + 1;
            const participantCard = document.createElement('div');
            participantCard.className = 'participant-card rounded-xl p-4';
            participantCard.style.animationDelay = `${currentCount * 0.1}s`;
            
            let participantTitle = `Participant ${participantIndex}`;
            
            // Special titles for specific events
            if (eventId === 'admeta-cat1' || eventId === 'admeta-cat2') {
                if (participantIndex === 1) participantTitle = 'Participant 1 (FOR the motion)';
                if (participantIndex === 2) participantTitle = 'Participant 2 (AGAINST the motion)';
            }
            
            participantCard.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h5 class="text-white font-medium">${participantTitle}</h5>
                    <button type="button" onclick="removeParticipant('${eventId}', this)" 
                            class="text-red-400 hover:text-red-300 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-1 text-sm">Full Name *</label>
                        <input type="text" name="participant_name_${eventId}[]" required 
                               class="input-field w-full px-3 py-2 rounded-lg text-sm"
                               placeholder="Enter participant's full name">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-1 text-sm">Grade *</label>
                        <select name="participant_grade_${eventId}[]" required 
                                class="input-field w-full px-3 py-2 rounded-lg text-sm">
                            <option value="">Select Grade</option>
                            ${Array.from({length: event.maxGrade - event.minGrade + 1}, (_, i) => 
                                `<option value="${event.minGrade + i}">${event.minGrade + i}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            `;
            
            participantList.appendChild(participantCard);
            updateParticipantCount(eventId);
            validateEvent(eventId);
        }

        // Remove participant
        function removeParticipant(eventId, button) {
            const event = classroomEvents.find(e => e._id === eventId);
            const participantCard = button.closest('.participant-card');
            const participantList = document.getElementById(`participant_list_${eventId}`);
            
            if (participantList.children.length <= event.minParticipants) {
                showMessage(`Minimum ${event.minParticipants} participants required for ${event.name}`, 'error');
                return;
            }
            
            participantCard.remove();
            updateParticipantCount(eventId);
            renumberParticipants(eventId);
            validateEvent(eventId);
        }

        // Remove last participant
        function removeLastParticipant(eventId) {
            const participantList = document.getElementById(`participant_list_${eventId}`);
            const lastParticipant = participantList.lastElementChild;
            
            if (lastParticipant) {
                const removeBtn = lastParticipant.querySelector('button');
                removeParticipant(eventId, removeBtn);
            }
        }

        // Renumber participants after removal
        function renumberParticipants(eventId) {
            const participantList = document.getElementById(`participant_list_${eventId}`);
            const participantCards = participantList.querySelectorAll('.participant-card');
            
            participantCards.forEach((card, index) => {
                const title = card.querySelector('h5');
                let participantTitle = `Participant ${index + 1}`;
                
                // Special titles for specific events
                if (eventId === 'admeta-cat1' || eventId === 'admeta-cat2') {
                    if (index === 0) participantTitle = 'Participant 1 (FOR the motion)';
                    if (index === 1) participantTitle = 'Participant 2 (AGAINST the motion)';
                }
                
                title.textContent = participantTitle;
            });
        }

        // Update participant count
        function updateParticipantCount(eventId) {
            const participantList = document.getElementById(`participant_list_${eventId}`);
            const count = participantList.children.length;
            const event = classroomEvents.find(e => e._id === eventId);
            
            document.getElementById(`count_${eventId}`).textContent = count;
            
            const addBtn = document.getElementById(`add_btn_${eventId}`);
            const removeBtn = document.getElementById(`remove_btn_${eventId}`);
            
            if (count >= event.maxParticipants) {
                addBtn.classList.add('hidden');
            } else {
                addBtn.classList.remove('hidden');
            }
            
            if (count > event.minParticipants) {
                removeBtn.classList.remove('hidden');
            } else {
                removeBtn.classList.add('hidden');
            }
        }

        // Validate event requirements
        function validateEvent(eventId) {
            const event = classroomEvents.find(e => e._id === eventId);
            const participantList = document.getElementById(`participant_list_${eventId}`);
            const count = participantList.children.length;
            const validationDiv = document.getElementById(`validation_${eventId}`);
            
            let messages = [];
            
            if (count < event.minParticipants) {
                messages.push(`⚠️ Need at least ${event.minParticipants} participants`);
            }
            
            // Special validation for 'Ad'venturium (grade mixed requirement)
            if (event.genderRequirement === 'grade_mixed_required') {
                const gradeSelects = participantList.querySelectorAll('select[name*="grade"]');
                const selectedGrades = Array.from(gradeSelects).map(s => parseInt(s.value));
                const hasLowerGrade = selectedGrades.some(g => g >= 9 && g <= 10);
                const hasHigherGrade = selectedGrades.some(g => g >= 11 && g <= 12);
                
                if (!hasLowerGrade || !hasHigherGrade) {
                    messages.push('⚠️ Need one Grade 9-10 and one Grade 11-12 participant');
                }
            }
            
            if (messages.length > 0) {
                validationDiv.innerHTML = `<div class="text-yellow-400">${messages.join('<br>')}</div>`;
            } else {
                validationDiv.innerHTML = '';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('continue-to-events').addEventListener('click', () => {
                if (validateSchoolInfo()) {
                    showEventsSection();
                }
            });
            
            document.getElementById('back-to-school').addEventListener('click', showSchoolSection);
            
            document.getElementById('registrationForm').addEventListener('submit', handleSubmit);
        }

        // Validate school information
        function validateSchoolInfo() {
            const requiredFields = ['schoolName', 'teacherName', 'teacherMobile', 'teacherEmail'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const input = document.querySelector(`[name="${field}"]`);
                if (!input.value.trim()) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input.classList.remove('border-red-500');
                }
            });
            
            if (!isValid) {
                showMessage('Please fill in all required school information fields.', 'error');
            }
            
            return isValid;
        }

        // Show events section
        function showEventsSection() {
            document.getElementById('school-section').classList.add('hidden');
            document.getElementById('events-section').classList.remove('hidden');
            currentStep = 2;
            updateProgress();
            
            // Update submit button text based on mode
            const submitText = document.getElementById('submit-text');
            if (editMode) {
                submitText.textContent = 'Update Registration';
                showExistingSummary();
            } else {
                submitText.textContent = 'Submit Registration';
            }
        }

        // Show existing registrations summary
        function showExistingSummary() {
            if (existingRegistrations.length > 0) {
                const summaryDiv = document.getElementById('existing-summary');
                const summaryContent = document.getElementById('summary-content');
                
                let summaryHTML = '';
                existingRegistrations.forEach(registration => {
                    summaryHTML += `
                        <div class="bg-green-800/20 rounded-lg p-3">
                            <h4 class="text-green-200 font-medium">${registration.eventName}</h4>
                            <p class="text-green-300 text-sm mt-1">
                                ${registration.participants.length} participant(s): 
                                ${registration.participants.map(p => p.name).join(', ')}
                            </p>
                        </div>
                    `;
                });
                
                summaryContent.innerHTML = summaryHTML;
                summaryDiv.classList.remove('hidden');
            }
        }

        // Show school section
        function showSchoolSection() {
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('school-section').classList.remove('hidden');
            currentStep = 1;
            updateProgress();
        }

        // Update progress bar
        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (currentStep === 1) {
                progressBar.style.width = '50%';
                progressText.textContent = 'Step 1 of 2';
            } else {
                progressBar.style.width = '100%';
                progressText.textContent = 'Step 2 of 2';
            }
        }

        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-registration');
            const submitText = document.getElementById('submit-text');
            const submitSpinner = document.getElementById('submit-spinner');
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = 'Submitting...';
            submitSpinner.classList.remove('hidden');
            
            try {
                const formData = collectFormData();
                
                if (!validateFormData(formData)) {
                    throw new Error('Please complete all required fields and event requirements.');
                }
                
                const response = await fetch('/api/register/classroom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const successMessage = editMode ? 
                        'Classroom events registration updated successfully! 🎉' : 
                        'Classroom events registration submitted successfully! 🎉';
                    showMessage(successMessage, 'success');
                    
                    // Redirect to panel after successful submission
                    setTimeout(() => {
                        window.location.href = '/panel';
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Registration failed');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showMessage(error.message, 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                const resetText = editMode ? 'Update Registration' : 'Submit Registration';
                submitText.textContent = resetText;
                submitSpinner.classList.add('hidden');
            }
        }

        // Collect form data
        function collectFormData() {
            const formData = {
                school: {
                    name: document.querySelector('[name="schoolName"]').value.trim(),
                    contingentCode: document.querySelector('[name="contingentCode"]').value.trim(),
                    teacherName: document.querySelector('[name="teacherName"]').value.trim(),
                    teacherMobile: document.querySelector('[name="teacherMobile"]').value.trim(),
                    teacherEmail: document.querySelector('[name="teacherEmail"]').value.trim()
                },
                events: []
            };
            
            // Collect event registrations
            classroomEvents.forEach(event => {
                const participateYes = document.querySelector(`input[name="participate_${event._id}"][value="yes"]`);
                if (participateYes && participateYes.checked) {
                    const participants = [];
                    const participantList = document.getElementById(`participant_list_${event._id}`);
                    
                    participantList.querySelectorAll('.participant-card').forEach((card, index) => {
                        const name = card.querySelector(`input[name="participant_name_${event._id}[]"]`).value.trim();
                        const grade = parseInt(card.querySelector(`select[name="participant_grade_${event._id}[]"]`).value);
                        
                        if (name && grade) {
                            // Convert to proper Title Case (e.g., "john doe" → "John Doe")
                            const titleCaseName = name.trim().toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
                            
                            const participant = {
                                name: titleCaseName,
                                grade: grade,
                                participantOrder: index + 1
                            };
                            
                            participants.push(participant);
                        }
                    });
                    
                    if (participants.length > 0) {
                        formData.events.push({
                            eventId: event._id,
                            participants: participants
                        });
                    }
                }
            });
            
            return formData;
        }

        // Validate form data
        function validateFormData(formData) {
            // Check school info
            const requiredSchoolFields = ['name', 'teacherName', 'teacherMobile', 'teacherEmail'];
            for (let field of requiredSchoolFields) {
                if (!formData.school[field]) {
                    return false;
                }
            }
            
            // Check at least one event is selected
            if (formData.events.length === 0) {
                showMessage('Please select at least one event to participate in.', 'error');
                return false;
            }
            
            // Validate each event
            for (let eventReg of formData.events) {
                const event = classroomEvents.find(e => e._id === eventReg.eventId);
                
                // Check participant count
                if (eventReg.participants.length < event.minParticipants || 
                    eventReg.participants.length > event.maxParticipants) {
                    showMessage(`${event.name} requires ${event.minParticipants === event.maxParticipants ? event.minParticipants : event.minParticipants + '-' + event.maxParticipants} participants.`, 'error');
                    return false;
                }
                
                // Check grade requirements
                for (let participant of eventReg.participants) {
                    if (participant.grade < event.minGrade || participant.grade > event.maxGrade) {
                        showMessage(`${event.name} is for grades ${event.minGrade}-${event.maxGrade} only.`, 'error');
                        return false;
                    }
                }
                
                // Special validation for 'Ad'venturium (grade mixed requirement)
                if (event.genderRequirement === 'grade_mixed_required') {
                    const grades = eventReg.participants.map(p => p.grade);
                    const hasLowerGrade = grades.some(g => g >= 9 && g <= 10);
                    const hasHigherGrade = grades.some(g => g >= 11 && g <= 12);
                    
                    if (!hasLowerGrade || !hasHigherGrade) {
                        showMessage(`${event.name} requires one Grade 9-10 and one Grade 11-12 participant.`, 'error');
                        return false;
                    }
                }
            }
            
            return true;
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageClass = type === 'success' ? 'success-message' : 'error-message';
            
            container.innerHTML = `
                <div class="${messageClass} rounded-xl p-4 text-white">
                    <div class="flex items-center">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-3"></i>
                        <span>${message}</span>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                container.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>